<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-image: url("http://demo.idrsoft.com/apm/assets/images/apm_bg.png");
            overflow: hidden;
            margin: 0;
        }

        .server-column {
            fill: rgb(4, 9, 19);
        }

        .request {
            fill: steelblue;
        }

        .tableRect {
            fill: orange;
        }

        .table {
            stroke: #333;
            stroke-width: 1;
        }

        .tableName {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-item span {
            color: white;
        }

        .legend-color {
            border-radius: 50%;
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }

        #network-graph {
            position: absolute;
            display: grid;
            right: 0;
            place-items: center;
            background-color: rgba(184, 184, 185, .12);
            margin: 13px;
        }

        .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row-reverse;
            width: 100%;
            background-color: #32427B;
        }

        .button-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }

        .button-next {
            background-color: #1e1f21;
            margin: 5px;
            border-radius: 5px;
        }

        .button-zoom {
            background-color: #1e1f21;
            margin: 5px;
            border-radius: 5px;
        }

        #system-container {
            height: 100vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
    <div id="network-graph"></div>
    <div id="system-container">
        <svg id="system"></svg>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.140.0/build/three.module.js"
            }
        }
    </script>
    <script type="module" src="./network-graph.js"></script>

    <script>
        var servers = ["WEB", "WAS", "DB"];
        var requests = [
            { id: "req1", name: 'service1', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 100, state: [], stateCount: 0, status: 'normal' },
            { id: "req2", name: 'service2', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 300, state: [], stateCount: 0, status: 'warning' },
            { id: "req3", name: 'service3', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 900, state: [], stateCount: 0, status: 'error' },
            { id: "req4", name: 'service4', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 800, state: [], stateCount: 0, status: 'warning' },
            { id: "req5", name: 'service5', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 500, state: [], stateCount: 0, status: 'normal' },
            { id: "req6", name: 'service6', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 200, state: [], stateCount: 0, status: 'error' },
            { id: "req7", name: 'service7', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 400, state: [], stateCount: 0, status: 'warning' },
            { id: "req8", name: 'service8', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 700, state: [], stateCount: 0, status: 'normal' },
            { id: "req9", name: 'service9', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 800, state: [], stateCount: 0, status: 'normal' },
            { id: "req10", name: 'service10', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 100, state: [], stateCount: 0, status: 'error' },

        ];

        requests.sort((a, b) => a.time - b.time)


        let width = 1200;
        let height = 300;


        var svg = d3.select("#system")
            .attr("width", width)
            .attr("height", height)
            .append("g");

        svg.selectAll(".server-column")
            .data(servers)
            .enter().append("rect")
            .attr("class", "server-column")
            .attr("x", function (d, i) {
                return i * (width / servers.length) + ((width / servers.length)) / 2 - 100;
            })
            .attr("y", 0)
            .attr("width", 800 / servers.length - 60)
            .attr("height", 300)
            .attr("stroke", "rgb(16, 86, 218)")
            .attr("stroke-width", 10)



        function performAction(action, currentServer) {
            switch (action) {
                case "register":
                    return 'WEB';
                case "WEBWAS":
                    return "WAS";
                case "WASDB":
                    return "DB";
                case "DBWAS":
                    return "WAS";
                case "WASWEB":
                    return "WEB";
                case "ungister":
                    return "WEB";
                default:
                    return null;
            }
        }

        function getColor(status) {
            switch (status) {
                case 'normal':
                    return 'steelblue';
                case 'warning':
                    return 'orange';
                case 'error':
                    return 'red';
                default:
                    return 'steelblue';
            }
        }

        var outerGroupElement = svg.append('g').attr("id", "outerGroup");

        function moveRequest(request, index, actionIndex) {
            var requestElement = svg.select("#" + request.id);

            var currentIndex = servers.indexOf(request.current);
            var currentServer = request.current;
            var action = request.actions[actionIndex];
            var nextServer = performAction(action, currentServer);
            var nextIndex = servers.indexOf(nextServer);
            var targetCircle = nextIndex * (width / servers.length) + (width / servers.length) / 2;
            var targetRect = nextIndex * (width / servers.length) + (width / servers.length) / 2;


            var groupElement = outerGroupElement.append('g')
                .attr("id", "rectTable")
                .attr("transform", function () {
                    var row = Math.floor(index / 2);
                    var col = index % 2;
                    var translateX = col * 90;
                    var translateY = row * 50;
                    return "translate(" + translateX + "," + translateY + ")";
                });

            requestElement.transition()
                .duration(1500)
                .delay(request.time)
                .attr("cx", targetCircle - 50)
                .style("fill", getColor(request.status))
                .transition()
                .duration(0)
                .style("opacity", 1)
                .on("end", function () {
                    if (currentIndex < nextIndex) {
                        var stateId = request.id + request.stateCount++;
                        request.state.push(stateId);

                        groupElement.append("rect")
                            .attr("id", stateId)
                            .attr("class", "tableRect")
                            .attr("x", targetRect - 80)
                            .attr("y", 30)
                            .attr('width', 80)
                            .attr('height', 40)
                            .style("fill", getColor(request.status));

                        // groupElement.append("rect")
                        //     .attr("id", stateId)
                        //     .attr("class", "tableRect")
                        //     .attr("x", targetRect - 30)
                        //     .attr("y", (index + 1) * 50 - 30)
                        //     .attr('width', 70)
                        //     .attr('height', 30)
                        //     .style("fill", getColor(request.status));

                        groupElement.append('text')
                            .attr('id', stateId)
                            .attr('class', 'tableName')
                            .attr("x", targetRect - 40)
                            .attr("y", 50)
                            .style("font-size", "20px")
                            .text(request.name);


                    }


                    request.current = nextServer;

                    if (request.current === "DB") {
                        request.next = "WAS";
                    } else if (request.current === "WAS") {
                        if (currentIndex < nextIndex) {
                            request.next = "DB";
                        } else {
                            request.next = "WEB";
                            var lastStateId = request.state.pop();
                            svg.selectAll("#" + lastStateId).attr("opacity", 0);
                        }
                    } else if (request.current === "WEB") {
                        if (currentIndex < nextIndex) {
                            request.next = "WAS";
                        } else {
                            request.next = "DB";
                            var lastStateId = request.state.pop();
                            console.log(request.state);
                            svg.selectAll("#" + lastStateId).attr("opacity", 0);
                        }
                    }
                    else if (request.current === "ungister") {
                        if (currentIndex < nextIndex) {
                            request.next = "WEB";
                        } else {
                            request.next = "WAS";
                            var lastStateId = request.state.pop();
                            svg.select("#" + lastStateId).attr("opacity", 0);
                        }
                    }
                    if (actionIndex < request.actions.length - 1) {
                        moveRequest(request, index, actionIndex + 1);
                    }
                });
        }
        var circleGroupElement = svg.insert('g', ':first-child').attr("id", "circleGroup");

        requests.forEach(function (request, index) {
            var circlegroupElement = circleGroupElement.append('g')
                .attr("id", "circleTable")
                .attr("transform", function () {
                    var row = Math.floor(index / 2);
                    var col = index % 2;
                    var translateX = col * 50;
                    var translateY = row * 50;

                    return "translate(" + translateX + "," + translateY + ")";
                });
            circlegroupElement.append("circle")
                .attr("id", request.id)
                .attr("cx", 0)
                .attr("cy", 30)
                .attr("r", 15)
                .style("fill", getColor(request.status))
                .style("opacity", 0)

            moveRequest(request, index, 0);
        });
    </script>
    <script type="module">
        import { NetWordChart } from './network-graph.js'
        d3.json("data.json").then(function (data) {
            const networkchart = new NetWordChart({
                Id: "network-graph",
                data: data,
                rotationY: 0.001,
                rotateSpeed: 400,
                lineSize: 0.001,
                width: 400,
                height: 300,
            })
        })
    </script>
</body>

</html>